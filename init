#!/bin/sh
VIP=${VIP?"mandatory parameter: <ip>/<prefix>"}
VNI=${VNI:='10'}
VXLAN=${VXLAN:="vxlan$VNI"}
IF=${IF:="eth0"}
HOSTS=${HOSTS:=""}
PORT=${PORT:="0"}
eval `ipcalc -hb $VIP` # HOSTNAME and BROADCAST

check(){
  until $1 2>1 >/dev/null; do usleep 100000; done
}
vxlan_found(){
  ip a show $VXLAN 2>&1 >/dev/null
}
addr_found(){
  ip a show $VXLAN to $HOSTNAME | grep . 2>&1 >/dev/null
}

until vxlan_found; do
  ip link add $VXLAN type vxlan id $VNI dev $IF dstport $PORT
done
check "ip link set $VXLAN up"
until addr_found; do
  check "ip a add $VIP broadcast $BROADCAST dev $VXLAN"
done
for H in $HOSTS; do
  check "bridge fdb append 00:00:00:00:00:00 dev $VXLAN dst $H"
done
echo "$VXLAN installed ($VIP) on $IF"
trap 'exit 0' SIGTERM
tail -f /dev/null &
wait
